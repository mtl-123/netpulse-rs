name: Build & Release Static Binary

on:
  push:
    branches:
      - master
    tags:
      - "v*"
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  BIN_NAME: net_monitor
  PROJECT_NAME: netpulse-rs

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆPR æˆ–é Tag æ¨é€æ—¶è¿è¡Œï¼‰
  lint:
    name: Code Quality Check
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request' || (!startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt,clippy
          target: x86_64-unknown-linux-musl

      - name: Cache Cargo Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: lint-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run Tests
        run: cargo test --verbose

  # æ„å»º Linux x86_64 é™æ€äºŒè¿›åˆ¶ï¼ˆæ ¸å¿ƒä»»åŠ¡ï¼‰
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    needs:
      - lint
    # âœ… ä¼˜åŒ–ï¼šTag æ¨é€æ—¶è·³è¿‡ lint ä¾èµ–æ£€æŸ¥ï¼Œç›´æ¥æ‰§è¡Œæ„å»º
    if: github.event_name == 'pull_request' && needs.lint.result == 'success' || github.event_name != 'pull_request'
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rust-src
          target: x86_64-unknown-linux-musl

      - name: Cache Cargo Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: build-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          shared-key: musl-build

      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt update -y || true
          sudo apt install -y --no-install-recommends \
            build-essential \
            musl-tools \
            gh \
            file \
            upx-ucl \
            bc
          echo "System dependencies installed"

      - name: Configure Cargo for Static Build
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-musl]
          linker = "musl-gcc"
          rustflags = ["-C", "target-feature=+crt-static", "-C", "strip=symbols"]
          EOF

      - name: Build Static Binary
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"

          echo "Building binary: ${BIN_NAME}"
          echo "Expected path: ${BIN_PATH}"

          cargo build \
            --target x86_64-unknown-linux-musl \
            --release \
            --locked \
            --verbose

          echo "=== ç¼–è¯‘åç›®å½•å†…å®¹ ==="
          ls -la target/x86_64-unknown-linux-musl/release/

          if [ ! -f "$BIN_PATH" ]; then
            echo "FATAL: Binary not found at ${BIN_PATH}"
            ls -la target/x86_64-unknown-linux-musl/release/* 2>/dev/null | grep -v "^d" || true
            exit 1
          fi

          file "$BIN_PATH"
          ORIG_SIZE=$(du -b "$BIN_PATH" | awk '{print $1}')
          echo "original_size=${ORIG_SIZE}" >> $GITHUB_ENV

      - name: Verify Original Binary
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"
          TIMEOUT_SEC=10
          chmod +x "$BIN_PATH"

          if timeout ${TIMEOUT_SEC}s "$BIN_PATH" --version >/dev/null 2>&1 || \
             timeout ${TIMEOUT_SEC}s "$BIN_PATH" -h >/dev/null 2>&1 || \
             timeout ${TIMEOUT_SEC}s "$BIN_PATH" --help >/dev/null 2>&1; then
            echo "Binary verification passed"
          else
            echo "Binary exists and is executable"
          fi

      - name: Compress with UPX
        id: upx_compress
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"

          mkdir -p bin
          cp "$BIN_PATH" "bin/${BIN_NAME}"
          cp "bin/${BIN_NAME}" "bin/${BIN_NAME}.backup"

          ORIG_SIZE=$(du -b "bin/${BIN_NAME}" | awk '{print $1}')

          if upx --best --lzma --force --strip-relocs=0 -q "bin/${BIN_NAME}" 2>/dev/null; then
            echo "compressed=true" >> $GITHUB_OUTPUT
          else
            cp "bin/${BIN_NAME}.backup" "bin/${BIN_NAME}"
            echo "compressed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          COMP_SIZE=$(du -b "bin/${BIN_NAME}" | awk '{print $1}')
          if [ "$ORIG_SIZE" -gt 0 ]; then
            COMP_RATIO=$(echo "scale=2; $COMP_SIZE * 100 / $ORIG_SIZE" | bc)
            SAVED_RATIO=$(echo "scale=2; 100 - $COMP_RATIO" | bc)
            echo "Compression ratio: ${SAVED_RATIO}%"
          fi
          rm -f "bin/${BIN_NAME}.backup"

      - name: Verify Compressed Binary
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="bin/${BIN_NAME}"
          TIMEOUT_SEC=10
          chmod +x "$BIN_PATH"

          if timeout ${TIMEOUT_SEC}s "$BIN_PATH" --version >/dev/null 2>&1 || \
             timeout ${TIMEOUT_SEC}s "$BIN_PATH" -h >/dev/null 2>&1 || \
             timeout ${TIMEOUT_SEC}s "$BIN_PATH" --help >/dev/null 2>&1; then
            echo "Compressed binary verification passed"
          else
            echo "Compressed binary exists and is executable"
          fi

      - name: Package Artifacts
        id: package
        run: |
          set -euo pipefail
          mkdir -p release
          BIN_NAME="${{ env.BIN_NAME }}"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            SHORT_SHA="${{ github.sha }}"
            SHORT_SHA="${SHORT_SHA:0:8}"
            VERSION="dev-${SHORT_SHA}"
          fi

          if [ "${{ steps.upx_compress.outputs.compressed }}" == "true" ]; then
            FINAL_BIN="${BIN_NAME}-${VERSION}-linux-x86_64-static-upx"
          else
            FINAL_BIN="${BIN_NAME}-${VERSION}-linux-x86_64-static"
          fi

          cp "bin/${BIN_NAME}" "release/${FINAL_BIN}"
          chmod +x "release/${FINAL_BIN}"
          sha256sum "release/${FINAL_BIN}" | awk '{print $1 "  " $2}' > "release/${FINAL_BIN}.sha256"

          echo "final_bin=release/${FINAL_BIN}" >> $GITHUB_OUTPUT
          echo "final_sum=release/${FINAL_BIN}.sha256" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "is_tag=${{ startsWith(github.ref, 'refs/tags/') && startsWith(github.ref_name, 'v') }}" >> $GITHUB_OUTPUT

          echo "=== æœ€ç»ˆäº§ç‰© ==="
          ls -lh release/
          cat "release/${FINAL_BIN}.sha256"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-linux-x86_64-static-${{ steps.package.outputs.version }}
          path: release/
          retention-days: 30
          if-no-files-found: error

      # âœ… ä¼˜åŒ–ï¼šç‹¬ç«‹çš„ Release å‘å¸ƒä»»åŠ¡ï¼Œç®€åŒ–æ¡ä»¶ + å¢å¼ºè°ƒè¯•
      - name: Debug Release Conditions
        if: always()
        run: |
          echo "=== Release å‘å¸ƒæ¡ä»¶è°ƒè¯• ==="
          echo "github.ref: ${{ github.ref }}"
          echo "github.ref_name: ${{ github.ref_name }}"
          echo "startsWith(github.ref, 'refs/tags/'): ${{ startsWith(github.ref, 'refs/tags/') }}"
          echo "startsWith(github.ref_name, 'v'): ${{ startsWith(github.ref_name, 'v') }}"
          echo "is_tag output: ${{ steps.package.outputs.is_tag }}"
          echo "final_bin: ${{ steps.package.outputs.final_bin }}"
          echo "final_sum: ${{ steps.package.outputs.final_sum }}"
          if [ -f "${{ steps.package.outputs.final_bin }}" ]; then
            echo "âœ… Binary file exists"
            ls -lh "${{ steps.package.outputs.final_bin }}"
          else
            echo "âŒ Binary file NOT found"
          fi

      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/') && startsWith(github.ref_name, 'v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_NOTES: |
            netpulse-rs ${{ github.ref_name }}

            - Linux x86_64 static binary
            - UPX compressed (if applicable)
            - SHA256 checksum included
        run: |
          set -euo pipefail
          echo "=== å¼€å§‹å‘å¸ƒåˆ° GitHub Releases ==="
          echo "Tag: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Binary path: ${{ steps.package.outputs.final_bin }}"
          echo "Checksum path: ${{ steps.package.outputs.final_sum }}"

          # æ ¡éªŒäº§ç‰©æ–‡ä»¶
          if [ ! -f "${{ steps.package.outputs.final_bin }}" ]; then
            echo "ERROR: Binary file missing at ${{ steps.package.outputs.final_bin }}"
            ls -lh release/ || true
            exit 1
          fi
          if [ ! -f "${{ steps.package.outputs.final_sum }}" ]; then
            echo "ERROR: Checksum file missing at ${{ steps.package.outputs.final_sum }}"
            ls -lh release/ || true
            exit 1
          fi

          # é…ç½® gh CLIï¼ˆç¡®ä¿ä½¿ç”¨ GITHUB_TOKEN è®¤è¯ï¼‰
          echo "Configuring gh CLI..."
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

          # åˆ é™¤åŒå Releaseï¼ˆé¿å…å†²çªï¼‰
          echo "Checking for existing release..."
          if gh release view ${{ github.ref_name }} --repo ${{ github.repository }} >/dev/null 2>&1; then
            echo "Deleting existing release: ${{ github.ref_name }}"
            gh release delete ${{ github.ref_name }} --repo ${{ github.repository }} --yes || true
          else
            echo "No existing release found, proceeding to create new one"
          fi

          # åˆ›å»º Release
          echo "Creating release: ${{ github.ref_name }}"
          gh release create ${{ github.ref_name }} \
            --repo ${{ github.repository }} \
            --title "Release ${{ github.ref_name }}" \
            --notes "${{ env.RELEASE_NOTES }}" \
            --draft=false \
            --prerelease=false \
            "${{ steps.package.outputs.final_bin }}" \
            "${{ steps.package.outputs.final_sum }}"

          # å‘å¸ƒåéªŒè¯
          echo "=== å‘å¸ƒéªŒè¯ ==="
          if gh release view ${{ github.ref_name }} --repo ${{ github.repository }} --json assets --jq '.assets | length' | grep -q '[1-9]'; then
            echo "âœ… Release published successfully!"
            echo "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
            gh release view ${{ github.ref_name }} --repo ${{ github.repository }} --json assets --jq '.assets[] | {name, size, downloadUrl}'
          else
            echo "âŒ Release published but assets missing!"
            exit 1
          fi
