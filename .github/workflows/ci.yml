# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# netpulse-rs - Build & Release Static Binary
# ç‰¹æ€§ï¼šRust é™æ€ç¼–è¯‘ | UPX å‹ç¼© | å¤šå¹³å°æ”¯æŒ | è‡ªåŠ¨ Release
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Build & Release Static Binary

on:
  push:
    branches: [master]                    # âœ… é€‚é…é»˜è®¤åˆ†æ”¯ mainï¼ˆå¯æ”¹å› masterï¼‰
    tags: ["v*"]                        # ä»…åŒ¹é… v å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ã€v2.1.3ï¼‰
  pull_request:
    branches: [master]                    # PR è§¦å‘æ„å»ºéªŒè¯ï¼ˆä¸å‘å¸ƒï¼‰
  workflow_dispatch:                    # æ‰‹åŠ¨è§¦å‘å…œåº•ï¼Œæ”¯æŒä»»æ„åˆ†æ”¯/Tag

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  BIN_NAME: netpulse-rs                 # âœ… ä¿®æ”¹ä¸º Rust é¡¹ç›®äºŒè¿›åˆ¶å
  PROJECT_NAME: netpulse-rs

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆPR/æ¨é€æ—¶è¿è¡Œï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Code Quality Check
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request' || (!startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy
          target: x86_64-unknown-linux-musl

      - name: Cache Cargo Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: lint-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Check Format
        run: cargo fmt --all -- --check

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run Tests
        run: cargo test --verbose

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: æ„å»º Linux x86_64 é™æ€äºŒè¿›åˆ¶ï¼ˆæ ¸å¿ƒ Jobï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    needs: [lint]                       # ä¾èµ– lint ä»»åŠ¡ï¼ˆPR æ—¶ï¼‰
    if: always() && (github.event_name != 'pull_request' || needs.lint.result == 'success')

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                # æ‹‰å–å®Œæ•´ Git å†å²

      # âœ… Rust å·¥å…·é“¾å®‰è£…ï¼ˆæ›¿æ¢åŸ Go æ­¥éª¤ï¼‰
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rust-src
          target: x86_64-unknown-linux-musl

      # âœ… Cargo ç¼“å­˜åŠ é€Ÿï¼ˆæ›¿æ¢åŸ Go ç¼“å­˜ï¼‰
      - name: Cache Cargo Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: build-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          shared-key: musl-build

      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt update -y || true
          sudo apt install -y --no-install-recommends \
            build-essential \
            musl-tools \
            gh \
            file \
            upx-ucl \
            bc

          # éªŒè¯å®‰è£…
          gcc --version
          musl-gcc --version || echo "musl-gcc å¯é€‰"
          gh --version
          upx --version || echo "UPX ç‰ˆæœ¬æ£€æŸ¥å®Œæˆ"
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…æˆåŠŸ"

      # âœ… Rust é™æ€ç¼–è¯‘ï¼ˆæ ¸å¿ƒæ­¥éª¤ - æ›¿æ¢ go buildï¼‰
      - name: Build Static Binary (musl)
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"

          # é…ç½® cargo ä½¿ç”¨ musl é“¾æ¥å™¨ï¼ˆç¡®ä¿å®Œå…¨é™æ€ï¼‰
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-musl]
          linker = "musl-gcc"
          rustflags = ["-C", "target-feature=+crt-static", "-C", "strip=symbols"]
          EOF

          # ç¼–è¯‘ Release ç‰ˆæœ¬
          cargo build \
            --target x86_64-unknown-linux-musl \
            --release \
            --locked \
            --verbose

          # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
          if [ ! -f "$BIN_PATH" ]; then
            echo "FATAL: äºŒè¿›åˆ¶æ–‡ä»¶æœªç”Ÿæˆï¼"
            ls -la target/x86_64-unknown-linux-musl/release/ || true
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸ºé™æ€é“¾æ¥
          echo "=== äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯ ==="
          file "$BIN_PATH"
          if file "$BIN_PATH" | grep -qi "statically linked"; then
            echo "âœ… ç¡®è®¤ä¸ºé™æ€é“¾æ¥äºŒè¿›åˆ¶"
          else
            echo "âš ï¸  æœªæ£€æµ‹åˆ° statically linked æ ‡è®°ï¼Œä½† musl ç›®æ ‡é€šå¸¸ä¸ºé™æ€"
          fi

          # è®°å½•æ–‡ä»¶å¤§å°
          ORIG_SIZE=$(du -b "$BIN_PATH" | awk '{print $1}')
          echo "original_size=${ORIG_SIZE}" >> $GITHUB_ENV
          echo "âœ… é™æ€ç¼–è¯‘æˆåŠŸ | å¤§å°: $(numfmt --to=iec-i --suffix=B $ORIG_SIZE)"

      # âœ… åŸå§‹äºŒè¿›åˆ¶æœ‰æ•ˆæ€§éªŒè¯ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
      - name: Verify Original Binary Runability
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"
          TIMEOUT_SEC=10

          chmod +x "$BIN_PATH"

          echo "=== æµ‹è¯•åŸå§‹äºŒè¿›åˆ¶åŸºç¡€åŠŸèƒ½ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰==="
          # Rust é¡¹ç›®é€šå¸¸æ”¯æŒ --version æˆ– -h
          if timeout ${TIMEOUT_SEC}s "$BIN_PATH" --version >/dev/null 2>&1; then
            echo "âœ… äºŒè¿›åˆ¶ --version æ£€æµ‹é€šè¿‡"
          elif timeout ${TIMEOUT_SEC}s "$BIN_PATH" -h >/dev/null 2>&1; then
            echo "âœ… äºŒè¿›åˆ¶ -h æ£€æµ‹é€šè¿‡"
          elif timeout ${TIMEOUT_SEC}s "$BIN_PATH" --help >/dev/null 2>&1; then
            echo "âœ… äºŒè¿›åˆ¶ --help æ£€æµ‹é€šè¿‡"
          else
            echo "âš ï¸  è½»é‡æ£€æµ‹æ— å“åº”ï¼ˆç¨‹åºå¯èƒ½ä¸ºäº¤äº’å¼/éœ€é…ç½®ï¼‰ï¼Œè·³è¿‡æ£€æµ‹"
            echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶å­˜åœ¨ä¸”å¯æ‰§è¡Œï¼Œè§†ä¸ºæœ‰æ•ˆ"
          fi

      # âœ… UPX å‹ç¼©ï¼ˆä¿ç•™åŸé€»è¾‘ï¼Œé€‚é… Rust äºŒè¿›åˆ¶ï¼‰
      - name: Compress Binary with UPX-UCL
        id: upx_compress
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"

          mkdir -p bin
          cp "$BIN_PATH" "bin/${BIN_NAME}"
          cp "bin/${BIN_NAME}" "bin/${BIN_NAME}.backup"

          echo "=== UPX å‹ç¼©å‰ä½“ç§¯ ==="
          ls -lh "bin/${BIN_NAME}"
          ORIG_SIZE=$(du -b "bin/${BIN_NAME}" | awk '{print $1}')

          # UPX å‹ç¼©ï¼ˆ--best --lzma æœ€é«˜å‹ç¼©ç‡ï¼‰
          if upx --best --lzma --force --strip-relocs=0 -q "bin/${BIN_NAME}" 2>/dev/null; then
            echo "âœ… UPX å‹ç¼©æˆåŠŸ"
            echo "compressed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  UPX å‹ç¼©å¤±è´¥ï¼ˆå¯èƒ½äºŒè¿›åˆ¶å·²ä¼˜åŒ–æˆ–ä¸å…¼å®¹ï¼‰ï¼Œä½¿ç”¨åŸå§‹äºŒè¿›åˆ¶"
            cp "bin/${BIN_NAME}.backup" "bin/${BIN_NAME}"
            echo "compressed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "=== UPX å‹ç¼©åä½“ç§¯ ==="
          ls -lh "bin/${BIN_NAME}"
          COMP_SIZE=$(du -b "bin/${BIN_NAME}" | awk '{print $1}')

          if [ "$ORIG_SIZE" -gt 0 ]; then
            COMP_RATIO=$(echo "scale=2; $COMP_SIZE * 100 / $ORIG_SIZE" | bc)
            SAVED_RATIO=$(echo "scale=2; 100 - $COMP_RATIO" | bc)
            echo "ğŸ“Š å‹ç¼©ç‡: ${SAVED_RATIO}% (åŸå§‹: $(numfmt --to=iec-i --suffix=B $ORIG_SIZE) â†’ å‹ç¼©å: $(numfmt --to=iec-i --suffix=B $COMP_SIZE))"
          fi

          rm -f "bin/${BIN_NAME}.backup"

      # âœ… å‹ç¼©åäºŒè¿›åˆ¶éªŒè¯ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
      - name: Verify Compressed Binary Runability
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="bin/${BIN_NAME}"
          BACKUP_PATH="${BIN_PATH}.backup"
          TIMEOUT_SEC=10

          chmod +x "$BIN_PATH"
          echo "=== æµ‹è¯• UPX å‹ç¼©åäºŒè¿›åˆ¶åŸºç¡€åŠŸèƒ½ ==="

          if ! (timeout ${TIMEOUT_SEC}s "$BIN_PATH" --version >/dev/null 2>&1 || \
                timeout ${TIMEOUT_SEC}s "$BIN_PATH" -h >/dev/null 2>&1 || \
                timeout ${TIMEOUT_SEC}s "$BIN_PATH" --help >/dev/null 2>&1); then
            echo "âš ï¸  å‹ç¼©åäºŒè¿›åˆ¶æ£€æµ‹æ— å“åº”ï¼Œå›æ»šåˆ°åŸå§‹äºŒè¿›åˆ¶"
            if [ -f "$BACKUP_PATH" ]; then
              cp "$BACKUP_PATH" "$BIN_PATH"
              chmod +x "$BIN_PATH"
              echo "âœ… å·²å›æ»šåˆ°åŸå§‹äºŒè¿›åˆ¶"
            fi
          else
            echo "âœ… å‹ç¼©åäºŒè¿›åˆ¶åŸºç¡€æœ‰æ•ˆæ€§æµ‹è¯•é€šè¿‡"
          fi
          rm -f "$BACKUP_PATH" 2>/dev/null || true

      # âœ… äº§ç‰©æ‰“åŒ…ï¼ˆä¿ç•™åŸå‘½åé€»è¾‘ï¼Œé€‚é… Rust é¡¹ç›®ï¼‰
      - name: Package (netpulse-rs Naming)
        id: package
        run: |
          set -euo pipefail
          mkdir -p release
          BIN_NAME="${{ env.BIN_NAME }}"

          # ç‰ˆæœ¬é€»è¾‘ï¼šTag å‘å¸ƒç”¨ Tag åï¼Œå¦åˆ™ç”¨ dev+SHA
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            RELEASE_TYPE="release"
          else
            COMMIT_SHA="${{ github.sha }}"
            SHORT_SHA="${COMMIT_SHA:0:8}"
            VERSION="dev-${SHORT_SHA}"
            RELEASE_TYPE="dev"
          fi

          # æ–‡ä»¶åé€»è¾‘ï¼šæ ¹æ® UPX å‹ç¼©ç»“æœæ·»åŠ åç¼€
          if [ "${{ steps.upx_compress.outputs.compressed }}" == "true" ]; then
            FINAL_BIN="${BIN_NAME}-${VERSION}-linux-x86_64-static-upx"
          else
            FINAL_BIN="${BIN_NAME}-${VERSION}-linux-x86_64-static"
          fi

          # å¤åˆ¶äº§ç‰© + ç”Ÿæˆæ ¡éªŒå’Œ
          cp "bin/${BIN_NAME}" "release/${FINAL_BIN}"
          chmod +x "release/${FINAL_BIN}"
          sha256sum "release/${FINAL_BIN}" | awk '{print $1 "  " $2}' > "release/${FINAL_BIN}.sha256"

          # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "final_bin=release/${FINAL_BIN}" >> $GITHUB_OUTPUT
          echo "final_sum=release/${FINAL_BIN}.sha256" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_type=${RELEASE_TYPE}" >> $GITHUB_OUTPUT

          echo "=== æœ€ç»ˆäº§ç‰© ==="
          ls -lh release/
          echo "æ ¡éªŒå’Œ:"
          cat "release/${FINAL_BIN}.sha256"

      # âœ… ä¸Šä¼  Artifactï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-linux-x86_64-static-${{ steps.package.outputs.version }}
          path: release/
          retention-days: 30
          if-no-files-found: error

      # âœ… GitHub Releases å‘å¸ƒï¼ˆä¿ç•™åŸé€»è¾‘ + å¢å¼ºæ ¡éªŒï¼‰
      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/') && startsWith(github.ref_name, 'v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "=== å¼€å§‹å‘å¸ƒåˆ° GitHub Releases ==="
          echo "å½“å‰ Tag: ${{ github.ref_name }}"
          echo "äº§ç‰©è·¯å¾„: ${{ steps.package.outputs.final_bin }}"
          echo "æ ¡éªŒå’Œè·¯å¾„: ${{ steps.package.outputs.final_sum }}"

          # ä¸¥æ ¼æ ¡éªŒäº§ç‰©æ–‡ä»¶
          if [ ! -f "${{ steps.package.outputs.final_bin }}" ]; then
            echo "ERROR: äºŒè¿›åˆ¶äº§ç‰©ç¼ºå¤±ï¼"
            ls -lh release/
            exit 1
          fi
          if [ ! -f "${{ steps.package.outputs.final_sum }}" ]; then
            echo "ERROR: æ ¡éªŒå’Œæ–‡ä»¶ç¼ºå¤±ï¼"
            exit           fi

          # åˆ é™¤åŒå Releaseï¼ˆé¿å…å†²çªï¼‰
          gh release delete ${{ github.ref_name }} --yes 2>/dev/null || \
            echo "âš ï¸  æ— åŒå Releaseï¼Œç›´æ¥åˆ›å»º"

          # åˆ›å»º Releaseï¼ˆä½¿ç”¨ gh CLIï¼‰
          gh release create ${{ github.ref_name }} \
            --repo ${{ github.repository }} \
            --title "Release ${{ github.ref_name }} ğŸš€" \
            --notes "## ğŸ“¦ ä¸‹è½½

- **${{ steps.package.outputs.final_bin }}** - Linux x86_64 é™æ€äºŒè¿›åˆ¶
- **${{ steps.package.outputs.final_sum }}** - SHA256 æ ¡éªŒå’Œ

## ğŸ”§ ä½¿ç”¨è¯´æ˜

\`\`\`bash
# ä¸‹è½½
wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ steps.package.outputs.final_bin }}

# éªŒè¯
sha256sum -c ${{ steps.package.outputs.final_bin }}.sha256

# æ‰§è¡Œ
chmod +x ${{ steps.package.outputs.final_bin }}
./${{ steps.package.outputs.final_bin }}
\`\`\`

## ğŸ“‹ å˜æ›´æ—¥å¿—

$(git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --oneline --no-merges || echo "- é¦–æ¬¡å‘å¸ƒ")
" \
            --draft=false \
            --prerelease=false \
            "${{ steps.package.outputs.final_bin }}" \
            "${{ steps.package.outputs.final_sum }}"

          # å‘å¸ƒåéªŒè¯
          echo "âœ… å‘å¸ƒæˆåŠŸï¼"
          echo "ğŸ”— Releases åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

          # æ‰“å°ä¸‹è½½é“¾æ¥
          gh release view ${{ github.ref_name }} --repo ${{ github.repository }} \
            --json assets --jq '.assets[] | "ğŸ“¥ \(.name): \(.browser_download_url)"'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: ï¼ˆå¯é€‰ï¼‰æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶ - å¯æ‰©å±•
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # build-cross-platform:
  #   name: Build ${{ matrix.target }}
  #   runs-on: ubuntu-22.04
  #   strategy:
  #     matrix:
  #       include:
  #         - target: aarch64-unknown-linux-musl
  #           name: linux-arm64
  #         - target: x86_64-apple-darwin
  #           name: macos-x86_64
  #   steps:
  #     # ... ç±»ä¼¼ build-linux-x86_64-staticï¼Œä½¿ç”¨ cross æˆ– zig äº¤å‰ç¼–è¯‘
  #     # é¢„ç•™æ‰©å±•æ¥å£ï¼Œå½“å‰ä»…æ„å»º x86_64 Linux
