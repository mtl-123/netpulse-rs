# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# netpulse-rs - Build & Release Static Binary
# ç‰¹æ€§ï¼šRust é™æ€ç¼–è¯‘ | UPX å‹ç¼© | è‡ªåŠ¨ Release | master åˆ†æ”¯é€‚é…
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Build & Release Static Binary

on:
  push:
    branches: [master]                    # âœ… ä¿®å¤ï¼šæ”¹å› master åˆ†æ”¯
    tags: ["v*"]
  pull_request:
    branches: [master]                    # âœ… ä¿®å¤ï¼šPR ä¹Ÿç›‘å¬ master
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  BIN_NAME: netpulse-rs
  PROJECT_NAME: netpulse-rs

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: ä»£ç è´¨é‡æ£€æŸ¥
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Code Quality Check
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request' || (!startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy
          target: x86_64-unknown-linux-musl

      - name: Cache Cargo Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: lint-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Check Format
        run: cargo fmt --all -- --check

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run Tests
        run: cargo test --verbose

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: æ„å»º Linux x86_64 é™æ€äºŒè¿›åˆ¶ï¼ˆæ ¸å¿ƒï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    needs: [lint]
    if: always() && (github.event_name != 'pull_request' || needs.lint.result == 'success')

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rust-src
          target: x86_64-unknown-linux-musl

      - name: Cache Cargo Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: build-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          shared-key: musl-build

      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt update -y || true
          sudo apt install -y --no-install-recommends \
            build-essential \
            musl-tools \
            gh \
            file \
            upx-ucl \
            bc
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…æˆåŠŸ"

      - name: Build Static Binary (musl)
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"

          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-musl]
          linker = "musl-gcc"
          rustflags = ["-C", "target-feature=+crt-static", "-C", "strip=symbols"]
          EOF

          cargo build \
            --target x86_64-unknown-linux-musl \
            --release \
            --locked \
            --verbose

          if [ ! -f "$BIN_PATH" ]; then
            echo "FATAL: äºŒè¿›åˆ¶æ–‡ä»¶æœªç”Ÿæˆï¼"
            ls -la target/x86_64-unknown-linux-musl/release/ || true
            exit 1
          fi

          echo "=== äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯ ==="
          file "$BIN_PATH"
          ORIG_SIZE=$(du -b "$BIN_PATH" | awk '{print $1}')
          echo "original_size=${ORIG_SIZE}" >> $GITHUB_ENV
          echo "âœ… é™æ€ç¼–è¯‘æˆåŠŸ | å¤§å°: $(numfmt --to=iec-i --suffix=B $ORIG_SIZE)"

      - name: Verify Original Binary Runability
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"
          TIMEOUT_SEC=10
          chmod +x "$BIN_PATH"

          echo "=== æµ‹è¯•åŸå§‹äºŒè¿›åˆ¶åŸºç¡€åŠŸèƒ½ ==="
          if timeout ${TIMEOUT_SEC}s "$BIN_PATH" --version >/dev/null 2>&1 || \
             timeout ${TIMEOUT_SEC}s "$BIN_PATH" -h >/dev/null 2>&1 || \
             timeout ${TIMEOUT_SEC}s "$BIN_PATH" --help >/dev/null 2>&1; then
            echo "âœ… äºŒè¿›åˆ¶åŸºç¡€åŠŸèƒ½æ£€æµ‹é€šè¿‡"
          else
            echo "âš ï¸ è½»é‡æ£€æµ‹æ— å“åº”ï¼Œè§†ä¸ºæœ‰æ•ˆï¼ˆäº¤äº’å¼ç¨‹åºï¼‰"
          fi

      - name: Compress Binary with UPX-UCL
        id: upx_compress
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/x86_64-unknown-linux-musl/release/${BIN_NAME}"

          mkdir -p bin
          cp "$BIN_PATH" "bin/${BIN_NAME}"
          cp "bin/${BIN_NAME}" "bin/${BIN_NAME}.backup"

          echo "=== UPX å‹ç¼©å‰ ==="
          ls -lh "bin/${BIN_NAME}"
          ORIG_SIZE=$(du -b "bin/${BIN_NAME}" | awk '{print $1}')

          if upx --best --lzma --force --strip-relocs=0 -q "bin/${BIN_NAME}" 2>/dev/null; then
            echo "âœ… UPX å‹ç¼©æˆåŠŸ"
            echo "compressed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ UPX å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹äºŒè¿›åˆ¶"
            cp "bin/${BIN_NAME}.backup" "bin/${BIN_NAME}"
            echo "compressed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "=== UPX å‹ç¼©å ==="
          ls -lh "bin/${BIN_NAME}"
          COMP_SIZE=$(du -b "bin/${BIN_NAME}" | awk '{print $1}')
          if [ "$ORIG_SIZE" -gt 0 ]; then
            COMP_RATIO=$(echo "scale=2; $COMP_SIZE * 100 / $ORIG_SIZE" | bc)
            SAVED_RATIO=$(echo "scale=2; 100 - $COMP_RATIO" | bc)
            echo "ğŸ“Š å‹ç¼©ç‡: ${SAVED_RATIO}%"
          fi
          rm -f "bin/${BIN_NAME}.backup"

      - name: Verify Compressed Binary Runability
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="bin/${BIN_NAME}"
          TIMEOUT_SEC=10
          chmod +x "$BIN_PATH"

          echo "=== æµ‹è¯•å‹ç¼©åäºŒè¿›åˆ¶ ==="
          if timeout ${TIMEOUT_SEC}s "$BIN_PATH" --version >/dev/null 2>&1 || \
             timeout ${TIMEOUT_SEC}s "$BIN_PATH" -h >/dev/null 2>&1 || \
             timeout ${TIMEOUT_SEC}s "$BIN_PATH" --help >/dev/null 2>&1; then
            echo "âœ… å‹ç¼©åäºŒè¿›åˆ¶æ£€æµ‹é€šè¿‡"
          else
            echo "âš ï¸ å‹ç¼©åæ£€æµ‹æ— å“åº”ï¼Œä½†æ–‡ä»¶æœ‰æ•ˆ"
          fi

      - name: Package (netpulse-rs Naming)
        id: package
        run: |
          set -euo pipefail
          mkdir -p release
          BIN_NAME="${{ env.BIN_NAME }}"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            RELEASE_TYPE="release"
          else
            SHORT_SHA="${{ github.sha }}"
            SHORT_SHA="${SHORT_SHA:0:8}"
            VERSION="dev-${SHORT_SHA}"
            RELEASE_TYPE="dev"
          fi

          if [ "${{ steps.upx_compress.outputs.compressed }}" == "true" ]; then
            FINAL_BIN="${BIN_NAME}-${VERSION}-linux-x86_64-static-upx"
          else
            FINAL_BIN="${BIN_NAME}-${VERSION}-linux-x86_64-static"
          fi

          cp "bin/${BIN_NAME}" "release/${FINAL_BIN}"
          chmod +x "release/${FINAL_BIN}"
          sha256sum "release/${FINAL_BIN}" | awk '{print $1 "  " $2}' > "release/${FINAL_BIN}.sha256"

          echo "final_bin=release/${FINAL_BIN}" >> $GITHUB_OUTPUT
          echo "final_sum=release/${FINAL_BIN}.sha256" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_type=${RELEASE_TYPE}" >> $GITHUB_OUTPUT

          echo "=== æœ€ç»ˆäº§ç‰© ==="
          ls -lh release/
          cat "release/${FINAL_BIN}.sha256"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-linux-x86_64-static-${{ steps.package.outputs.version }}
          path: release/
          retention-days: 30
          if-no-files-found: error

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # âœ… ä¿®å¤ï¼šç®€åŒ– Release å‘å¸ƒé€»è¾‘ï¼Œé¿å… YAML è¯­æ³•é”™è¯¯
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/') && startsWith(github.ref_name, 'v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "=== å‘å¸ƒåˆ° GitHub Releases ==="
          echo "Tag: ${{ github.ref_name }}"
          echo "äº§ç‰©: ${{ steps.package.outputs.final_bin }}"

          # æ ¡éªŒäº§ç‰©
          if [ ! -f "${{ steps.package.outputs.final_bin }}" ]; then
            echo "ERROR: äºŒè¿›åˆ¶æ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi
          if [ ! -f "${{ steps.package.outputs.final_sum }}" ]; then
            echo "ERROR: æ ¡éªŒå’Œæ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi

          # åˆ é™¤åŒå Releaseï¼ˆé¿å…å†²çªï¼‰
          gh release delete ${{ github.ref_name }} --yes 2>/dev/null || true

          # åˆ›å»º Releaseï¼ˆç®€åŒ– notesï¼Œé¿å… YAML è½¬ä¹‰é—®é¢˜ï¼‰
          gh release create ${{ github.ref_name }} \
            --repo ${{ github.repository }} \
            --title "Release ${{ github.ref_name }}" \
            --notes "## ğŸ“¦ netpulse-rs ${{ github.ref_name }}

  # âœ… Linux x86_64 é™æ€äºŒè¿›åˆ¶
  # âœ… UPX å‹ç¼©ä¼˜åŒ–ï¼ˆå¦‚é€‚ç”¨ï¼‰
  # âœ… SHA256 æ ¡éªŒå’ŒéªŒè¯

  ### å¿«é€Ÿä½¿ç”¨
  \`\`\`bash
  wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ steps.package.outputs.final_bin }}
  sha256sum -c ${{ steps.package.outputs.final_bin }}.sha256
  chmod +x ${{ steps.package.outputs.final_bin }}
  ./${{ steps.package.outputs.final_bin }}
  \`\`\`" \
            --draft=false \
            --prerelease=false \
            "${{ steps.package.outputs.final_bin }}" \
            "${{ steps.package.outputs.final_sum }}"

          echo "âœ… å‘å¸ƒæˆåŠŸ"
          echo "ğŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
